<html>
<head><title>sync Unit Tests</title></head>
<link rel="stylesheet" href="/js/test/qunit.css" type="text/css" media="screen" />
<body>
<h1 id="qunit-header">QUnit example</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>

<script type="text/javascript" src="/js/libs/jquery-1.5.min.js"></script>
<script type="text/javascript" src="/js/gsd/sync.js"></script>
<script type="text/javascript" src="/js/test/qunit.js"></script>
<script type="text/javascript">
test("Basic sync", function () {
    // Replicants
    var a = {
        siteId: 'siteA',
        connected: true,
        // Simulate the IndexedDb
        indexedDb: {},
    };
    var b = {
        siteId: 'siteB',
        connected: true,
        // Simulate the IndexedDb
        indexedDb: {},
    };

    // IndexedDb Object Store
    var os = 'contexts'; 

    a.indexedDb[os] = {};
    b.indexedDb[os] = {};
 
    var site = {
        commit: function (op) {
            switch (op.opCode) {
                case ADD:
                    this.localAdd(op.os, op.key, op.value);
                case PUT:
                    this.localPut(op.os, op.key, op.value);
                case DEL:
                    this.localDelete(op.os, op.key);
            }
        },
        localAdd: function (os, key, value) {
            var o = $.extend(true, {}, value);
            this.indexedDb[os][key] = o;
        },
        localPut: function (os, key, value) {
            ok(!!this.indexedDb[os][key], os + ':' + key + " should exist");
            var o = $.extend(true, {}, value);
            this.indexedDb[os][key] = o;
        },
        localDelete: function (os, key) {
            delete this.indexedDb[os][key];
        }
    };
    a.__proto__ = site;
    b.__proto__ = site;
    
    // A context object to be stored in contexts
    // item0 here would normally be a uuid
    var content0 = {key: 'item0', name: 'Test 0'};

    // Star topology, ops is global
    var ops = [];
    // Simulate Unhosted
    window._propagate = function (op) {
        ops.push(ops);
    }

    // Simulate Unhosted
    // Have a site process updates from the Unhosted message queue
    window._receive = function (site) {
        for (var i=0; i < ops.length; i++) {
            site.receiveUpdate(ops[i]);
        }
    }
    a.localAdd(os, content0.key, content0);
    var aOp0 = newOperation(a.siteId, ADD, os, content0.key, content0);
    content0.name = 'Test 0 changed';
    notEqual(content0.name, a.indexedDb[os][content0.key].name, "Copy by value, need local or remote commit");
    a.localPut(os, content0.key, content0);
    equal(content0.name, a.indexedDb[os][content0.key].name, "Testing test simulation of local add");
    var aOp0 = newOperation(a.siteId, PUT, os, content0.key, content0);

});// test("Basic sync")
</script>
</body>
</html>
